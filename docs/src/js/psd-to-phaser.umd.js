(function(C,M){typeof exports=="object"&&typeof module<"u"?module.exports=M(require("phaser")):typeof define=="function"&&define.amd?define(["phaser"],M):(C=typeof globalThis<"u"?globalThis:C||self,C.PsdToPhaserPlugin=M(C.Phaser))})(this,(function(C){"use strict";var bt=Object.defineProperty;var xt=(C,M,O)=>M in C?bt(C,M,{enumerable:!0,configurable:!0,writable:!0,value:O}):C[M]=O;var T=(C,M,O)=>xt(C,typeof M!="symbol"?M+"":M,O);function M(o,e,t,n,r){return new Promise(s=>{let i=e.length;e.forEach(a=>{const l=a.name,c=`${t}/${a.filePath}`,f=()=>{i--,n(),i===0&&s()};a.type==="atlas"?O(o,l,c,a,f,r):a.type==="spritesheet"||a.type==="animation"?he(o,l,c,a,f,r):ge(o,l,c,f,r)}),i===0&&s()})}function O(o,e,t,n,r,s){console.log(`[${Date.now()}] Starting loadAtlas for key: ${e}`);const i={frames:{}};Object.entries(n.frames).forEach(([l,c])=>{i.frames[l]={frame:{x:c.x,y:c.y,w:c.width,h:c.height},rotated:!1,trimmed:!1,sourceSize:{w:c.width,h:c.height},spriteSourceSize:{x:0,y:0,w:c.width,h:c.height}}}),o.load.atlas(e,t,i);const a=()=>{o.textures.exists(e)?(s&&console.log(`ðŸ—ºï¸ Loaded atlas: ${e} from ${t}`),o.load.off("complete",a),r()):setTimeout(a,100)};o.load.on("complete",a),o.load.on("loaderror",l=>{console.error("Error loading file: ",l),o.load.off("complete",a)})}function he(o,e,t,n,r,s){o.load.spritesheet(e,t,{frameWidth:n.frame_width,frameHeight:n.frame_height}),o.load.once(`filecomplete-spritesheet-${e}`,()=>{s&&console.log(`ðŸ’¥ Loaded spritesheet: ${e} from ${t}`);for(let i=0;i<(n.frame_count??1);i++)r()})}function ge(o,e,t,n,r){o.load.image(e,t),o.load.once(`filecomplete-image-${e}`,()=>{r&&console.log(`ðŸŽ‘ Loaded image: ${e} from ${t}`),n()})}function W(o,e,t,n,r,s){const i=`${e.tilesetName}_tile_${e.col}_${e.row}`,a=`${t}/tiles/${e.tilesetName}/${n}/${i}.${e.filetype??"png"}`;!o.textures.exists(i)&&!o.textures.getTextureKeys().includes(i)&&!o.load.textureManager.exists(i)?(o.load.image(i,a),o.load.once(`filecomplete-image-${i}`,()=>{r(),s&&console.log(`ðŸ§© Loaded tile: ${i} from ${a}`)}),o.load.start()):(r(),s&&console.log(`Tile already loaded or loading: ${i}`))}function pe(o,e,t,n,r,s,i){e.forEach(a=>{for(let l=0;l<a.columns;l++)for(let c=0;c<a.rows;c++){const f={tilesetName:a.name,col:l,row:c,filetype:a.filetype},u=`${a.name}_tile_${l}_${c}`;i.push(u),W(o,f,t,n,()=>{const y=i.indexOf(u);y>-1&&i.splice(y,1),r()},s)}})}function K(o,e,t,n){const r=n.getData(e);if(!r||!r.basePath){console.error(`Invalid PSD data for key: ${e}`);return}const s=r.basePath,i=r.original.tile_slice_size??150,a=me(t),l=a.tiles+a.sprites+a.singleTiles+a.atlases;let c=0;const f=[];n.isDebugEnabled("console")&&(console.log(`Total assets to load: ${l}`),console.log(`Tiles to load: ${a.tiles}`),console.log(`Sprites to load: ${a.sprites}`),console.log(`Single tiles to load: ${a.singleTiles}`),console.log(`Atlases to load: ${a.atlases}`),console.log(`Tile slice size: ${i}`));const u=()=>{c++;const y=c/l;o.events.emit("psdLoadProgress",y),n.isDebugEnabled("console")&&console.log(`â³ Progress: ${c} of ${l} ( ${(y*100).toFixed(2)}% )`),c===l&&(o.events.emit("psdLoadComplete"),n.isDebugEnabled("console")&&console.log("All PSD assets loaded"))};t.tiles&&t.tiles.length>0&&pe(o,t.tiles,s,i,u,n.isDebugEnabled("console"),f),t.singleTiles&&t.singleTiles.length>0&&t.singleTiles.forEach(y=>{W(o,y,s,i,u,n.isDebugEnabled("console"))}),t.sprites&&t.sprites.length>0&&M(o,t.sprites,s,u,n.isDebugEnabled("console")),o.load.isLoading()||o.load.start()}function me(o){let e=0,t=0,n=0,r=0;o.tiles&&o.tiles.forEach(i=>{i.lazyLoad||(e+=i.columns*i.rows)}),o.singleTiles&&(n=o.singleTiles.length);const s=i=>{i.forEach(a=>{a.lazyLoad||(a.type==="atlas"?r++:a.type==="spritesheet"?t+=a.frame_count??1:t++)})};return o.sprites&&s(o.sprites),{tiles:e,sprites:t,singleTiles:n,atlases:r}}function V(o){return o.category==="sprite"}function Z(o){return o.category==="tileset"}function H(o){return o.category==="zone"}function U(o){return o.category==="point"}function F(o){return o.category==="group"&&Array.isArray(o.children)}function ye(o,e,t,n,r,s){if(!t||!Array.isArray(t.layers)){console.error(`Invalid or missing layers data for key: ${e}`);return}const i={original:JSON.parse(JSON.stringify(t)),basePath:n,initialLoad:{sprites:[],tiles:[],zones:[],points:[],groups:[]},lazyLoad:{sprites:[],tiles:[],zones:[],points:[],groups:[]}};q(t.layers,i,!1,s==null?void 0:s.lazyLoad),r.setData(e,i),r.isDebugEnabled("console")&&console.log(`Processed JSON for key "${e}":`,i),K(o,e,i.initialLoad,r)}function q(o,e,t,n){o.forEach(r=>{var a;let s=t||((a=r.attributes)==null?void 0:a.lazyLoad)===!0;n!==void 0&&(n===!0||Array.isArray(n)&&n.includes(r.name))&&(s=!0);const i=s?e.lazyLoad:e.initialLoad;Z(r)?i.tiles.push(r):V(r)?i.sprites.push(r):H(r)?i.zones.push(r):U(r)?i.points.push(r):F(r)&&(i.groups.push(r),q(r.children,e,s,n))})}function be(o){return function(e,t){if(!Array.isArray(t)||t.length===0){console.error("loadMultiple requires an array of PSD configurations");return}let n=0;const r=t.map(s=>new Promise((i,a)=>{const l=`${s.path}/data.json`,c=`${s.key}_temp_json`;e.load.json(c,l),e.load.once(`filecomplete-json-${c}`,(f,u,y)=>{if(y){const x=Pe(y,s.lazyLoad);n+=x,s._tempData=y,i()}else console.error(`Failed to load JSON for key: ${s.key}`),a(new Error(`Failed to load JSON for key: ${s.key}`))}),e.load.once("loaderror",f=>{f.key===c&&(console.error(`Failed to load JSON file: ${l}`),a(new Error(`Failed to load JSON file: ${l}`)))})}));e.load.isLoading()||e.load.start(),Promise.all(r).then(()=>{t.forEach(a=>{const l=a._tempData,c=xe(l,a.position),f={original:JSON.parse(JSON.stringify(c)),basePath:a.path,positionOffset:a.position,isMultiplePsd:!0,initialLoad:{sprites:[],tiles:[],zones:[],points:[],groups:[]},lazyLoad:{sprites:[],tiles:[],zones:[],points:[],groups:[]}};ee(c.layers,f,!1,a.lazyLoad),o.setData(a.key,f),o.isDebugEnabled("console")&&console.log(`Processed multi-PSD data for key "${a.key}":`,f)});let s=0;const i=()=>{s++;const a=s/n;e.events.emit("psdLoadProgress",a),o.isDebugEnabled("console")&&console.log(`â³ Multi-PSD Progress: ${s} of ${n} (${(a*100).toFixed(2)}%)`),s===n&&(e.events.emit("psdLoadComplete"),o.isDebugEnabled("console")&&console.log("All multi-PSD assets loaded"))};t.forEach(a=>{const l=o.getData(a.key);l&&ve(e,a.key,l.initialLoad,o,i)}),e.load.isLoading()||e.load.start()}).catch(s=>{console.error("Failed to load multiple PSDs:",s)})}}function xe(o,e){const t=JSON.parse(JSON.stringify(o));function n(r){r.forEach(s=>{s.x+=e.x,s.y+=e.y,s.instances&&Array.isArray(s.instances)&&s.instances.forEach(i=>{i.x+=e.x,i.y+=e.y}),s.children&&Array.isArray(s.children)&&n(s.children)})}return t.layers&&Array.isArray(t.layers)&&n(t.layers),t}function Pe(o,e){let t=0;function n(r,s=!1){r.forEach(i=>{let a=s||i.lazyLoad===!0;if(e!==void 0&&(e===!0||Array.isArray(e)&&e.includes(i.name))&&(a=!0),!a)switch(i.category){case"tileset":t+=(i.columns||1)*(i.rows||1);break;case"sprite":i.type==="atlas"?t++:i.type==="spritesheet"?t+=i.frame_count||1:t++;break}i.children&&Array.isArray(i.children)&&n(i.children,a)})}return o.layers&&Array.isArray(o.layers)&&n(o.layers),t}function ve(o,e,t,n,r){const s=n.getData(e);if(!s||!s.basePath){console.error(`Invalid PSD data for key: ${e}`);return}const i=s.basePath,a=s.original.tile_slice_size||150;t.tiles&&t.tiles.length>0&&_e(o,t.tiles,i,a,r,n.isDebugEnabled("console"),[],e),t.singleTiles&&t.singleTiles.length>0&&t.singleTiles.forEach(l=>{Q(o,l,i,a,r,n.isDebugEnabled("console"),e)}),t.sprites&&t.sprites.length>0&&$e(o,t.sprites,i,r,n.isDebugEnabled("console"),e)}function $e(o,e,t,n,r,s){e.forEach(i=>{const a=i.name,l=`${s}_${a}`,c=`${t}/${i.filePath}`,f=()=>{n()};i.type==="atlas"?we(o,a,l,c,i,f,r):i.type==="spritesheet"||i.type==="animation"?De(o,a,l,c,i,f,r):Le(o,a,l,c,f,r)})}function we(o,e,t,n,r,s,i){const a={frames:{}};Object.entries(r.frames).forEach(([c,f])=>{a.frames[c]={frame:{x:f.x,y:f.y,w:f.width,h:f.height},rotated:!1,trimmed:!1,sourceSize:{w:f.width,h:f.height},spriteSourceSize:{x:0,y:0,w:f.width,h:f.height}}}),o.load.atlas(t,n,a);const l=()=>{o.textures.exists(t)?(i&&console.log(`ðŸ—ºï¸ Loaded atlas: ${t} from ${n}`),o.load.off("complete",l),s()):setTimeout(l,100)};o.load.on("complete",l)}function De(o,e,t,n,r,s,i){o.load.spritesheet(t,n,{frameWidth:r.frame_width,frameHeight:r.frame_height}),o.load.once(`filecomplete-spritesheet-${t}`,()=>{i&&console.log(`ðŸ’¥ Loaded spritesheet: ${t} from ${n}`);for(let a=0;a<(r.frame_count||1);a++)s()})}function Le(o,e,t,n,r,s){o.load.image(t,n),o.load.once(`filecomplete-image-${t}`,()=>{s&&console.log(`ðŸŽ‘ Loaded image: ${t} from ${n}`),r()})}function _e(o,e,t,n,r,s,i,a){e.forEach(l=>{for(let c=0;c<l.columns;c++)for(let f=0;f<l.rows;f++){const u=`${l.name}_tile_${c}_${f}`,y=`${a}_${u}`;i.push(y);const x={tilesetName:l.name,col:c,row:f,filetype:l.filetype};Q(o,x,t,n,()=>{const w=i.indexOf(y);w>-1&&i.splice(w,1),r()},s,a)}})}function Q(o,e,t,n,r,s,i){const a=`${e.tilesetName}_tile_${e.col}_${e.row}`,l=`${i}_${a}`,c=`${t}/tiles/${e.tilesetName}/${n}/${a}.${e.filetype||"png"}`;o.textures.exists(l)?(r(),s&&console.log(`Tile already loaded: ${l}`)):(o.load.image(l,c),o.load.once(`filecomplete-image-${l}`,()=>{r(),s&&console.log(`ðŸ§© Loaded tile: ${l} from ${c}`)}))}function ee(o,e,t,n){o.forEach(r=>{let s=t||r.lazyLoad===!0;n!==void 0&&(n===!0||Array.isArray(n)&&n.includes(r.name))&&(s=!0);const i=s?e.lazyLoad:e.initialLoad;switch(r.category){case"tileset":i.tiles.push(r);break;case"sprite":i.sprites.push(r);break;case"zone":i.zones.push(r);break;case"point":i.points.push(r);break;case"group":i.groups.push(r),Array.isArray(r.children)&&ee(r.children,e,s,n);break}})}function Ae(o){return{load(e,t,n,r){const s=`${n}/data.json`;e.load.json(t,s),e.load.once(`filecomplete-json-${t}`,(i,a,l)=>{l?ye(e,t,l,n,o,r):console.error(`Loaded JSON is empty or invalid for key: ${t}`)}),e.load.once("loaderror",i=>{i.key===t&&console.error(`Failed to load JSON file: ${s}`)}),e.load.isLoading()||e.load.start()},loadMultiple:be(o)}}function te(o,e,t){const n=o.getData(e);if(!n||!n.lazyLoad)return!1;const s={sprite:"sprites",tileset:"tiles",zone:"zones",point:"points",group:"groups"}[t.category];if(!s)return!1;const i=n.lazyLoad[s];return i?i.some(a=>a.name===t.name):!1}function Y(o,e,t){const n=o.add.container(e.x,e.y);if(t.isDebugEnabled("shape")){const r=o.add.graphics();r.lineStyle(2,16711935,1),r.strokeRect(0,0,e.width,e.height),n.add(r)}if(t.isDebugEnabled("label")){const r=o.add.text(0,-20,`${e.name} (Lazy)`,{fontSize:"16px",color:"#ff00ff",backgroundColor:"#ffffff"});n.add(r)}return n}function N(o,e){o.attributes&&(e.attributes=o.attributes)}function Se(o,e,t,n,r,s,i){const a=o.add.container(e.x,e.y);if(a.setName(e.name),a.setData("tileData",e),a.setData("tileSliceSize",n),a.setData("psdKey",i),a.setDepth(e.initialDepth??0),N(e,a),["setX","setY","setPosition","setBlendMode","setAlpha","setDepth","setMask"].forEach(u=>{Me(a,u)}),te(t,i,e)){const u=Y(o,e,t);u&&a.add(u)}else{const u=t.getData(i),y=(u==null?void 0:u.isMultiplePsd)||!1;Ge(o,a,e,n,y,i)}r.add(a);const f=o.add.group();Ce(o,e,n,f,t),r.debugGroup=f}function Ge(o,e,t,n,r=!1,s){for(let i=0;i<t.columns;i++)for(let a=0;a<t.rows;a++){const l=i*n,c=a*n,u=`${r&&s?`${s}_${t.name}`:t.name}_tile_${i}_${a}`,y=oe(o,{x:l,y:c,key:u,initialDepth:t.initialDepth},e);y&&e.add(y)}}function Me(o,e){const t=Phaser.GameObjects.Container.prototype[e];o[e]=function(...n){const r=t.apply(this,n);if(["setX","setY","setPosition"].includes(e)){const i=e==="setX"||e==="setPosition"?n[0]-this.x:0,a=e==="setY"?n[0]-this.y:e==="setPosition"?n[1]-this.y:0;this.each(l=>{i!==0&&(l.x+=i),a!==0&&(l.y+=a)})}else this.each(i=>{typeof i[e]=="function"&&i[e](...n)});const s=this.getData("pendingMethodCalls")||[];return s.push({method:e,args:n}),this.setData("pendingMethodCalls",s),r}}function oe(o,e,t){if(o.textures.exists(e.key)){const n=o.add.image(e.x,e.y,e.key);return n.setOrigin(0,0),(t instanceof Phaser.GameObjects.Group||t instanceof Phaser.GameObjects.Container)&&t.add(n),n}else return console.warn(`Texture not found for tile: ${e.key}`),null}function Ce(o,e,t,n,r){if(r.isDebugEnabled("shape")){const i=o.add.graphics();i.setDepth(1e3),i.lineStyle(2,16711680,1),i.strokeRect(e.x,e.y,e.columns*t,e.rows*t),i.isDebugObject=!0,n.add(i)}if(r.isDebugEnabled("label")){const i=o.add.text(e.x,e.y-20,e.name,{fontSize:"16px",color:"#ff0000",backgroundColor:"#ffffff"});i.setDepth(1e3),i.isDebugObject=!0,n.add(i)}}function ke(o,e,t,n,r){const s=o.add.sprite(e.x,e.y,r||e.name);return s.setName(e.name),s.setOrigin(0,0),s.setDepth(e.initialDepth??0),N(e,s),e.frame!==void 0&&s.setFrame(e.frame),s}function ze(o,e,t,n,r){const s=o.add.group();s.name=e.name;const i=r||e.name;if(o.textures.exists(i)){const l=o.textures.get(i).getFrameNames(),c=Object.keys(e.frames).reduce((f,u,y)=>(f[u]=y,f),{});e.instances&&e.instances.forEach(f=>{const{name:u,x:y,y:x}=f,w=c[u];if(w!==void 0&&w<l.length){const $=l[w],g=o.add.sprite(y,x,i,$);g.setName(u),g.setOrigin(0,0),s.add(g),g.setDepth(e.initialDepth??0),t.isDebugEnabled("console")&&console.log(`Placed spritesheet instance: ${u}, at (${y}, ${x}), using frame: ${$}`)}else console.warn(`Frame for "${u}" not found in spritesheet "${i}"`)})}else console.error(`Texture "${i}" not found. Make sure the spritesheet is loaded correctly.`);return s.setDepth(e.initialDepth??0),N(e,s),s}function Ee(o,e,t,n,r){const s=o.add.group();s.name=e.name;const i=r||e.name;if(o.textures.exists(i)){const l=o.textures.get(i).getFrameNames();e.instances&&e.instances.forEach(c=>{const{name:f,x:u,y}=c;if(l.includes(f)){const x=o.add.sprite(u,y,i,f);x.setName(f),x.setOrigin(0,0),s.add(x),x.setDepth(e.initialDepth??0)}else console.warn(`Frame "${f}" not found in atlas "${i}"`)})}else console.error(`Texture "${i}" not found. Make sure the atlas is loaded correctly.`);return s.setDepth(e.initialDepth??0),N(e,s),s}function Te(o,e,t,n,r,s){var l,c,f,u,y,x,w,$;const i=r||e.name,a=o.add.sprite(e.x,e.y,i,0);if(a.setName(e.name),a.setOrigin(0,0),a.setDepth(e.initialDepth??0),N(e,a),e.frame_width&&e.frame_height){const g={key:i,frames:o.anims.generateFrameNumbers(i,{start:0,end:e.frame_count?e.frame_count-1:-1}),frameRate:((l=e.attributes)==null?void 0:l.frameRate)||24,repeat:((c=e.attributes)==null?void 0:c.repeat)!==void 0?e.attributes.repeat:-1};((f=e.attributes)==null?void 0:f.yoyo)!==void 0&&(g.yoyo=e.attributes.yoyo),((u=e.attributes)==null?void 0:u.delay)!==void 0&&(g.delay=e.attributes.delay),((y=e.attributes)==null?void 0:y.repeatDelay)!==void 0&&(g.repeatDelay=e.attributes.repeatDelay),((x=e.attributes)==null?void 0:x.duration)!==void 0&&(g.duration=e.attributes.duration),((w=e.attributes)==null?void 0:w.showOnStart)!==void 0&&(g.showOnStart=e.attributes.showOnStart),(($=e.attributes)==null?void 0:$.hideOnComplete)!==void 0&&(g.hideOnComplete=e.attributes.hideOnComplete),s&&(Object.assign(g,s),g.key=i,s.frames||(g.frames=o.anims.generateFrameNumbers(i,{start:0,end:e.frame_count?e.frame_count-1:-1}))),o.anims.exists(i)||o.anims.create(g),a.play(i)}return a}function ne(o,e,t,n,r,s,i){if(e.lazyLoad){const c=Y(o,e,t);c&&n.add(c),r();return}const a=t.getData(s),l=a!=null&&a.isMultiplePsd?`${s}_${e.name}`:e.name;if(o.textures.exists(l)){let c=null;switch(e.type){case"spritesheet":c=ze(o,e,t,s,l);break;case"atlas":c=Ee(o,e,t,s,l);break;case"animation":c=Te(o,e,t,s,l,i);break;default:c=ke(o,e,t,s,l);break}if(c){c instanceof Phaser.GameObjects.Group?c.getChildren().forEach(u=>{n.add(u)}):n.add(c),e.alpha!==void 0&&c.setAlpha(e.alpha),e.hidden!==void 0&&c.setVisible(!1),c.setDepth(e.initialDepth||0);const f=o.add.group();Ne(o,e,f,t),n.debugGroup=f}else console.error(`Failed to place sprite: ${e.name}`)}else console.warn(`Texture not found for sprite: ${e.name} (looking for texture key: ${l})`);r()}function Ne(o,e,t,n){if(n.isDebugEnabled("shape")){const s=o.add.graphics();s.setDepth(1e3),s.lineStyle(2,65280,1),s.strokeRect(e.x,e.y,e.width,e.height),s.isDebugObject=!0,t.add(s)}if(n.isDebugEnabled("label")){const s=o.add.text(e.x,e.y-20,e.name,{fontSize:"16px",color:"#00ff00",backgroundColor:"#ffffff"});s.setDepth(1e3),s.isDebugObject=!0,t.add(s)}}function Oe(o,e,t,n,r,s){const i=Ie(o,e);if(i){n.add(i);const a=o.add.group();Be(o,e,a,t),n.debugGroup=a}}function Ie(o,e){const t=j(e);let n,r;if(t instanceof Phaser.Geom.Polygon){const s=Phaser.Geom.Polygon.GetAABB(t);n=o.add.zone(s.x,s.y,s.width,s.height),r=t.points}else n=o.add.zone(t.x,t.y,t.width,t.height),r=[new Phaser.Geom.Point(t.x,t.y),new Phaser.Geom.Point(t.x+t.width,t.y),new Phaser.Geom.Point(t.x+t.width,t.y+t.height),new Phaser.Geom.Point(t.x,t.y+t.height)];return n.setName(e.name||"unnamed_zone"),N(e,n),n.setData("points",r),n.setData("category",e.category),n.setData("x",e.x),n.setData("y",e.y),n.setData("width",e.width),n.setData("height",e.height),e.initialDepth!==void 0&&n.setData("initialDepth",e.initialDepth),e.attributes&&n.setData("attributes",e.attributes),n}function j(o){if(o.subpaths&&Array.isArray(o.subpaths)&&o.subpaths.length>0&&Array.isArray(o.subpaths[0])){const e=o.subpaths[0].flatMap(t=>new Phaser.Geom.Point(t[0],t[1]));return new Phaser.Geom.Polygon(e)}else if(o.bbox&&typeof o.bbox=="object"){const{left:e,top:t,right:n,bottom:r}=o.bbox;if(typeof e=="number"&&typeof t=="number"&&typeof n=="number"&&typeof r=="number")return new Phaser.Geom.Rectangle(e,t,n-e,r-t)}return console.error("Unable to create zone shape. Invalid zone data:",o),new Phaser.Geom.Rectangle(0,0,1,1)}function Be(o,e,t,n){if(n.isDebugEnabled("shape")){const s=j(e),i=o.add.graphics();i.lineStyle(2,255,1),s instanceof Phaser.Geom.Polygon?i.strokePoints(s.points,!0):i.strokeRect(s.x,s.y,s.width,s.height),i.setDepth(1e3),i.isDebugObject=!0,t.add(i)}if(n.isDebugEnabled("label")){const s=j(e);let i,a;if(s instanceof Phaser.Geom.Polygon){const c=Phaser.Geom.Polygon.GetAABB(s);i=c.centerX,a=c.centerY}else i=s.centerX,a=s.centerY;const l=o.add.text(i,a,e.name,{fontSize:"16px",color:"#0000ff",backgroundColor:"#ffffff"});l.setOrigin(.5),l.setDepth(1e3),l.isDebugObject=!0,t.add(l)}}function Re(o,e,t,n,r,s){const i=Xe(o,e);if(i){n.add(i);const a=o.add.group();Ve(o,e,a,t),n.debugGroup=a}}function Xe(o,e){const t=o.add.container(e.x,e.y);return t.setData("pointData",e),t.setName(e.name),N(e,t),t}function Ve(o,e,t,n){if(n.isDebugEnabled("shape")){const s=o.add.circle(e.x,e.y,5,16711680);s.setStrokeStyle(2,16711680),s.setDepth(1e3),s.isDebugObject=!0,t.add(s)}if(n.isDebugEnabled("label")){const s=o.add.text(e.x,e.y-20,e.name,{fontSize:"16px",color:"#ff0000",backgroundColor:"#ffffff"});s.setOrigin(.5,1),s.setDepth(1e3),s.isDebugObject=!0,t.add(s)}}const se=["setAlpha","setAngle","setActive","setAlpha","setBlendMode","setDepth","setDisplaySize","setFlip","setMask","setOrigin","setPipeline","setPosition","setRotation","setScale","setScrollFactor","setSize","setTint","setVisible","setX","setY","setZ"];function Fe(o,e){e instanceof Phaser.GameObjects.Group?Ye(o,e):je(o,e)}function Ye(o,e){se.forEach(t=>{e[t]=Je(o,t)})}function je(o,e){se.forEach(t=>{t==="remove"&&(e[t]=(n={})=>{e.removedFromScene()})})}function Je(o,e){return function(...t){const n=typeof t[t.length-1]=="object"&&!Array.isArray(t[t.length-1])?t.pop():{},r=n.depth!==void 0?n.depth:1/0;ie(this,e,t,r,0)}}function ie(o,e,t,n,r){r>n||(o instanceof Phaser.GameObjects.Group?r<n&&o.getChildren().forEach(i=>{ie(i,e,t,n,r+1)}):typeof o[e]=="function"&&o[e](...t))}function We(o){return function(t,n={}){let r,s=1/0;typeof t=="string"?(r=t,s=n.depth!==void 0?n.depth:1/0):typeof t=="object"&&(s=t.depth!==void 0?t.depth:1/0);let i=!1;const a=(c,f=0)=>{if(!(f>=s)){if(c instanceof Phaser.GameObjects.Group&&(c.getChildren().forEach(u=>a(u,f+1)),f===s)){c.clear(),i=!0;return}"parentContainer"in c&&c.parentContainer?c.parentContainer.remove(c):c.scene&&c.scene.children.remove(c),typeof c.destroy=="function"&&c.destroy(!0),i=!0}},l=(c,f)=>{if(f.length===0)return a(c),!0;if(c instanceof Phaser.GameObjects.Group){const u=f[0],y=c.getChildren().find(x=>x.name===u);if(y)return l(y,f.slice(1))}return!1};if(r){const c=r.split("/");i=l(this,c)}else a(this);return i||console.warn(`Object not found or already removed: ${r||"root"}`),i}}function Ke(o,e){e.remove=We()}function Ze(o,e){e instanceof Phaser.GameObjects.Group?Ue(o,e):e instanceof Phaser.GameObjects.Sprite&&He(o,e)}function He(o,e){e.updateAnimation=function(t){return re(e,t)}}function Ue(o,e){e.updateAnimation=function(t){function n(r){r instanceof Phaser.GameObjects.Sprite&&r.anims&&r.anims.currentAnim?re(r,t):r instanceof Phaser.GameObjects.Group&&r.getChildren().forEach(n)}return n(e),e}}function re(o,e){var i;const t=(i=o.anims.currentAnim)==null?void 0:i.key;if(!t)return console.warn("No animation currently playing on sprite"),o;const n=o.scene,r=n.anims.get(t);if(!r)return console.warn(`Animation ${t} not found`),o;const s={key:t,frames:r.frames.map(a=>({key:a.textureKey,frame:a.textureFrame})),frameRate:r.frameRate,duration:r.duration,repeat:r.repeat,repeatDelay:r.repeatDelay,yoyo:r.yoyo,showOnStart:r.showOnStart,hideOnComplete:r.hideOnComplete,...e};return s.key=t,n.anims.remove(t),n.anims.create(s),o.play(t),o}function qe(o){return function(t,n={}){if(!t)return this;const r=t.split("/"),s=n.depth!==void 0?n.depth:1/0;function i(l,c,f){if(f>s||c.length===0)return null;const[u,...y]=c;let x;if(l instanceof Phaser.GameObjects.Group)x=l.getChildren();else if(l instanceof Phaser.GameObjects.Container)x=l.list;else return null;const w=x.filter($=>!$.isDebugObject);for(const $ of w)if($.name===u){if(y.length===0)return $;if($ instanceof Phaser.GameObjects.Group||$ instanceof Phaser.GameObjects.Container)return i($,y,f+1)}for(const $ of w)if($ instanceof Phaser.GameObjects.Group||$ instanceof Phaser.GameObjects.Container){const g=i($,c,f+1);if(g)return g}return null}let a=null;return this instanceof Phaser.GameObjects.Group||this instanceof Phaser.GameObjects.Container?a=i(this,r,0):a=this.name===r[0]?this:null,a?ae(o,a):console.warn(`Item not found at path: ${t}`),a}}function Qe(o,e){e.target=qe(o)}function ae(o,e){Fe(o,e),Ke(o,e),Ze(o,e),Qe(o,e)}function J(o,e){if(e.length===0)return null;const[t,...n]=e,r=o.find(s=>s.name===t);return r?n.length===0?r:F(r)?J(r.children,n):null:null}function et(o){return function(t,n,r,s={}){const i=o.getData(n);if(!i||!i.original)return console.error(`No data found for key: ${n}`),t.add.group();const a=i.original.tile_slice_size||150,l=t.add.group(),c=J(i.original.layers,r.split("/"));if(!c)return console.error(`No layer found with path: ${r}`),l;const f=le(t,c,o,a,l,n,s);return ae(o,f),t.events.emit("layerPlaced",r),f}}function le(o,e,t,n,r,s,i){if(F(e)){if(i.depth===void 0||i.depth>0){const l=o.add.group();return l.name=e.name,e.children.forEach(c=>{const f=le(o,c,t,n,l,s,{...i,depth:i.depth!==void 0?i.depth-1:void 0});f instanceof Phaser.GameObjects.GameObject&&l.add(f)}),r.add(l),l}return r}if(te(t,s,e)){const l=Y(o,e,t);return l&&r.add(l),r}return Z(e)?(Se(o,e,t,n,r,()=>{},s),r):V(e)?(ne(o,e,t,r,()=>{},s,i.animationOptions),r):H(e)?(Oe(o,e,t,r),r):U(e)?(Re(o,e,t,r),r):(console.error(`Unknown layer category: ${e.category}`),r)}function tt(o){return function(t,n,r){const s=o.getData(n);if(!s)return console.log(`No PSD data found for key: ${n}`),null;const i=r.split("/"),a=J(s.original.layers,i);if(!a)return console.log(`Sprite not found: ${r}`),console.log(`Available sprites: ${JSON.stringify(s.original.layers.map(u=>u.name))}`),null;if(!V(a))return console.log(`Layer "${r}" is not a sprite layer`),null;const c=s.isMultiplePsd||!1?`${n}_${a.name}`:a.name;if(t.textures.exists(c))return t.textures.get(c);const f=`${s.basePath}/${a.filePath}`;return t.load.image(c,f),t.load.once(`filecomplete-image-${c}`,()=>{console.log(`Texture loaded: ${c}`)}),t.load.start(),t.load.once("complete",()=>{console.log(`Load complete for: ${c}`)}),t.textures.exists(c)?t.textures.get(c):(console.log(`Failed to load texture: ${c}`),null)}}function ot(o,e,t={}){const n=e.scene;let r=!1,s=!1,i=new Phaser.Math.Vector2,a=new Phaser.Math.Vector2,l=new Phaser.Math.Vector2;const f={...{easeDragging:!1,friction:.95,minSpeed:.1,ignore:[]},...t};function u(){f.useBounds&&(typeof f.useBounds=="object"?(console.log("using custom size"),e.setBounds(f.useBounds.x,f.useBounds.y,f.useBounds.width,f.useBounds.height)):console.warn("useBounds object must have {x, y, width, height} format"))}function y(p){const v=[];let D=p;for(;D;)D.name&&v.unshift(D.name),D=D.parentContainer||null;return v.join("/")}function x(p){if(!f.ignore||f.ignore.length===0)return!1;const v=y(p),D=p.name||"";for(const S of f.ignore)if(D===S||v===S||v.endsWith("/"+S)||v.startsWith(S+"/")||v===S||v.includes("/"+S+"/"))return!0;return!1}function w(p){if(!f.ignore||f.ignore.length===0)return!1;const v=n.input.hitTestPointer(p);for(const D of v)if(x(D))return!0;return!1}function $(p){s||w(p)||(r=!0,l.copy(p),i.copy(p),a.reset(),n.events.emit("draggableStart",e))}function g(p){if(!r)return;const v=p.x-i.x,D=p.y-i.y;e.scrollX-=v/e.zoom,e.scrollY-=D/e.zoom,a.set(-v,-D),i.copy(p),n.events.emit("draggableActive",e)}function _(){r=!1,f.easeDragging||a.reset(),n.events.emit("draggableComplete",e)}function A(){!r&&f.easeDragging&&(a.length()>f.minSpeed?(e.scrollX+=a.x/e.zoom,e.scrollY+=a.y/e.zoom,a.scale(f.friction),n.events.emit("draggableActive",e)):a.reset())}function P(){n.input.on("pointerdown",$),n.input.on("pointermove",g),n.input.on("pointerup",_),n.events.on("update",A)}return P(),u(),{isDragging:()=>r,isPaused:()=>s,getVelocity:()=>a.clone(),setOptions:p=>{Object.assign(f,p),u(),f.easeDragging||a.reset()},pause:()=>{s=!0,r&&(r=!1,a.reset(),n.events.emit("draggableComplete",e))},resume:()=>{s=!1}}}function nt(o,e,t={}){var I;const n=e.scene,r=t.targetKeys||st(o);if(r.length===0)return console.warn("No PSDs found for lazy loading"),{};const s=[];if(r.forEach(d=>{const m=o.getData(d);if(m&&m.lazyLoad&&(m.lazyLoad.sprites&&m.lazyLoad.sprites.forEach(L=>{s.push({...L,_psdKey:d})}),m.lazyLoad.tiles)){const L=m.original.tile_slice_size??150;m.lazyLoad.tiles.forEach(h=>{S(h,L).forEach(b=>{s.push({...b,_psdKey:d})})})}}),s.length===0)return(I=t.debug)!=null&&I.console&&console.log("No lazy load items found in target PSDs:",r),{};let i,a=null,l=[],c=new Set,f=null,u=null;function y(){var d,m;t.createBoundaryCamera&&x(),w(),$(),((d=t.debug)!=null&&d.shape||(m=t.debug)!=null&&m.label)&&g(),A(),k()}function x(){u=n.cameras.add(),u.setVisible(!1),u.setZoom(1),u.setScroll(e.scrollX,e.scrollY),u.setSize(e.width,e.height)}function w(){const d=t.extendPreloadBounds||0;if(u){u.setScroll(e.scrollX,e.scrollY);const m=e.width/e.zoom,L=e.height/e.zoom,h=e.scrollX+e.width/2,b=e.scrollY+e.height/2;i=new Phaser.Geom.Rectangle(h-m/2-d,b-L/2-d,m+d*2,L+d*2)}else{const m=e.width/e.zoom,L=e.height/e.zoom;i=new Phaser.Geom.Rectangle(e.scrollX-d,e.scrollY-d,m+d*2,L+d*2)}}function $(){var m,L;const d=h=>{const b=n.add.rectangle(h.x,h.y,h.width,h.height);return b.setOrigin(0,0),b.setStrokeStyle(1,65280),b.setDepth(1e3),{boundary:b,data:{...h,loaded:!1}}};l=s.map(d),(m=t.debug)!=null&&m.shape?l.forEach(h=>h.boundary.setVisible(!0)):l.forEach(h=>h.boundary.setVisible(!1)),(L=t.debug)!=null&&L.label&&l.forEach(h=>{const b=n.add.text(h.boundary.x,h.boundary.y-20,h.data.name,{fontSize:"12px",color:"#00ffff",backgroundColor:"#000000"});b.setOrigin(0,1),b.setDepth(1001)})}function g(){a=n.add.graphics(),a.setDepth(1e3),_()}function _(){a&&(a.clear(),a.lineStyle(2,16711935,1),a.strokeRect(i.x,i.y,i.width,i.height))}function A(){var m;const d=l.filter(({boundary:L,data:h})=>!h.loaded&&!c.has(P(h))&&Phaser.Geom.Intersects.RectangleToRectangle(L.getBounds(),i));d.length>0&&((m=t.debug)!=null&&m.console&&console.log(`LazyLoad: ${d.length} objects to load`),n.events.emit("lazyLoadStart",d.length),d.forEach(p))}function P(d){if(!d)return"unknown";const m=d.category||d.type;return m==="tile"||m==="tileset"?`tile_${d.tilesetName||d.name}_${d.col}_${d.row}`:`sprite_${d.name}_${Math.round(d.x)}_${Math.round(d.y)}`}function p({data:d}){var b;const m=P(d);c.add(m);const L=d._psdKey;(b=t.debug)!=null&&b.console&&console.log(`LazyLoad: Loading object ${m} from PSD ${L}`);const h={sprites:d.category==="sprite"?[d]:[],tiles:[],singleTiles:d.category==="tile"||d.category==="tileset"?[d]:[]};K(n,L,h,o),n.load.once("complete",()=>{v(d)}),n.load.start()}function v(d){var b,z,E;const m=P(d);if(c.delete(m),d.loaded=!0,(b=t.debug)!=null&&b.console&&console.log(`LazyLoad: Object loaded ${m}`),d.category==="sprite"){const G=n.add.group();ne(n,d,o,G,()=>{G.getChildren().forEach(B=>{B.setDepth&&d.initialDepth!==void 0&&B.setDepth(d.initialDepth)}),n.children.sort("depth")},d._psdKey)}else if(d.category==="tile"||d.category==="tileset"){const G=D(n,d);oe(n,{x:d.x-G.x,y:d.y-G.y,key:`${d.tilesetName}_tile_${d.col}_${d.row}`,initialDepth:d.initialDepth,tilesetName:d.tilesetName,col:d.col,row:d.row},G)}const L=l.filter(({data:G})=>G.loaded).length/l.length,h=Array.from(c);n.events.emit("lazyLoadProgress",L,h),(z=t.debug)!=null&&z.console&&console.log(`LazyLoad: Progress ${L.toFixed(2)}, Remaining:`,h),l.every(({data:G})=>G.loaded)&&(n.events.emit("lazyLoadingComplete"),(E=t.debug)!=null&&E.console&&console.log("LazyLoad: All objects loaded")),_()}function D(d,m){const L=d.children.list.find(E=>E instanceof Phaser.GameObjects.Container&&E.name===m.tilesetName);if(L)return L;const h=m.x-m.col*m.tile_slice_size,b=m.y-m.row*m.tile_slice_size,z=d.add.container(h,b);return z.setName(m.tilesetName),z.setDepth(m.initialDepth),z}function S(d,m){const L=[];for(let h=0;h<d.columns;h++)for(let b=0;b<d.rows;b++)L.push({category:"tile",name:`${d.name}_tile_${h}_${b}`,x:d.x+h*m,y:d.y+b*m,width:m,height:m,tile_slice_size:m,filetype:d.filetype||"png",tilesetName:d.name,col:h,row:b,initialDepth:d.initialDepth});return L}function k(){const d=t.checkInterval||300;f=window.setInterval(()=>{X()},d)}function X(){var d,m;w(),A(),((d=t.debug)!=null&&d.shape||(m=t.debug)!=null&&m.label)&&_()}return y(),{update:X,destroy:()=>{f!==null&&(window.clearInterval(f),f=null),l.forEach(d=>d.boundary.destroy()),a&&a.destroy(),u&&(n.cameras.remove(u),u=null)}}}function st(o){return o.getAllKeys()}function it(o,e,t,n={}){const r=e;if(t.includes("draggable")&&Object.assign(r,ot(o,e,n.draggable)),t.includes("lazyLoad")){const s=typeof n.lazyLoad=="boolean"?{}:n.lazyLoad??{};Object.assign(r,nt(o,e,s))}return r}function rt(o){return function(e){let t,n;if(Array.isArray(e))if(e.length===2)typeof e[1]=="function"?(t={normal:e[0]},n={click:e[1]}):(t=e[0],n=e[1]);else if(e.length===3)t={normal:e[0],hover:e[1]},n={click:e[2]};else{console.error("Button: Invalid array format");return}else{console.error("Button: Invalid input format");return}if(!t.normal){console.error("Button requires at least a normal image");return}let r=t.normal,s=t.normal;if(s instanceof Phaser.GameObjects.Group){const g=s.getChildren();if(g.length===0){console.error("Button target group is empty");return}r=g[0]}else if(s instanceof Phaser.GameObjects.Container){if(s.list.length===0){console.error("Button target container is empty");return}r=s.list[0]}const i=r.scene;if(!i){console.error("Button target must have a valid scene");return}if(typeof r.setInteractive!="function"){console.error("Button target does not support interaction:",r.constructor.name);return}let a="normal";const l=r;let c,f,u,y;if(typeof l.getBounds=="function"){const g=l.getBounds();c=g.centerX||g.x+g.width/2,f=g.centerY||g.y+g.height/2,u=g.width,y=g.height}else c=l.x||0,f=l.y||0,u=l.width||l.displayWidth||100,y=l.height||l.displayHeight||100;const x=i.add.rectangle(c,f,u,y,0,0);x.setInteractive(),x.setDepth(Number.MAX_SAFE_INTEGER),x.setVisible(!0),t.normal&&t.normal.setVisible(!0),t.hover&&t.hover.setVisible(!1),t.active&&t.active.setVisible(!1);function w(g){t.normal&&t.normal.setVisible(!1),t.hover&&t.hover.setVisible(!1),t.active&&t.active.setVisible(!1);const _=t[g];_?_.setVisible(!0):t.normal&&t.normal.setVisible(!0),a=g}const $=i.sys.game.device.input.touch;return x.on("pointerdown",(g,_,A,P)=>{t.active&&w("active"),n.mousePress&&n.mousePress(s,{localX:_,localY:A,event:P},g)}),x.on("pointerup",(g,_,A,P)=>{var p;t.active&&(!$&&t.hover&&((p=x.input)!=null&&p.isOver)?w("hover"):w("normal")),n.click&&n.click(s,{localX:_,localY:A,event:P},g)}),!$&&t.hover&&(x.on("pointerover",(g,_,A,P)=>{w("hover"),n.mouseOver&&n.mouseOver(s,{localX:_,localY:A,event:P},g)}),x.on("pointerout",(g,_)=>{a!=="active"&&(w("normal"),n.mouseOut&&n.mouseOut(s,{event:_},g))})),a="normal",{destroy:()=>{x.off("pointerover"),x.off("pointerout"),x.off("pointerdown"),x.off("pointerup"),x.destroy()},getCurrentState:()=>a,showState:g=>{w(g)}}}}function at(o){return function(e,t,n={}){const r=e.scene;if(!r){console.error("Unable to determine scene for fillZone");return}const s=e.getData("points");if(!s||s.length===0){console.error("Zone does not have valid points data");return}const i=new Phaser.Geom.Polygon(s),a=Phaser.Geom.Polygon.GetAABB(i);let l,c;if(t instanceof Phaser.GameObjects.Group){const A=t.getChildren()[0];if(!A){console.error("Group is empty");return}l=A.texture.key,c=n.useFrames||[A.frame.name]}else l=t.texture.key,c=n.useFrames||[t.frame.name];const f=r.textures.get(l);if(!f){console.error(`Texture not found: ${l}`);return}if(!c||c.length===0){const A=f.getFrameNames();A.length>0?c=A:c=Array.from({length:f.frameTotal},(P,p)=>p)}const u=r.add.group(),y=n.minInstances!==void 0?n.minInstances:5,x=n.maxInstances!==void 0?n.maxInstances:10,w=Phaser.Math.Between(y,x);let $=0,g=w*10,_=0;for(;$<w&&_<g;){const A=Phaser.Math.Between(a.left,a.right),P=Phaser.Math.Between(a.top,a.bottom);if(Phaser.Geom.Polygon.Contains(i,A,P)){const p=Phaser.Math.RND.pick(c),v=r.add.sprite(A,P,l,p);if(n.scaleRange){const D=Phaser.Math.FloatBetween(n.scaleRange[0],n.scaleRange[1]);v.setScale(D)}if(n.tint&&n.tint.length>0){const D=Phaser.Math.RND.pick(n.tint);v.setTint(D)}u.add(v),$++}_++}return console.log(`fillZone completed. Sprites placed: ${$}, Target: ${w}, Attempts: ${_}`),u}}function lt(o){return function(e,t,n,r={}){const s=t.scene,i=r.bounceBack||!1,a=r.joystickRadius||50;e.setOrigin(.5,.5),e.setPosition(e.x+e.width/2,e.y+e.height/2);const l={x:e.x,y:e.y},c=t.getData("points"),f=c?new Phaser.Geom.Polygon(c):t.getBounds();let u=null;const y=(P,p)=>{const v=ce(f),D=new Phaser.Math.Vector2(P-v.x,p-v.y);D.length()>a&&D.setLength(a);const k={x:v.x+D.x,y:v.y+D.y};return c?Phaser.Geom.Polygon.Contains(f,k.x,k.y)?k:ct(f,k.x,k.y):{x:Phaser.Math.Clamp(k.x,f.left,f.right),y:Phaser.Math.Clamp(k.y,f.top,f.bottom)}},x=(P,p)=>{const v=ce(f);return{x:(P-v.x)/a,y:(p-v.y)/a}},w=(P,p)=>P.x>=p.left&&P.x<=p.right&&P.y>=p.top&&P.y<=p.bottom,$=P=>{u===null&&w(P,e.getBounds())&&(u=P,s.events.emit("joystickStart",{[n]:{isActive:!0,position:{x:e.x,y:e.y},change:{x:0,y:0},normalized:{x:0,y:0}}}))},g=P=>{if(P===u){const{x:p,y:v}=y(P.x,P.y);e.setPosition(p,v);const D={x:p-l.x,y:v-l.y},S=x(p,v);s.events.emit("joystickActive",{[n]:{isActive:!0,position:{x:p,y:v},change:D,normalized:S}})}},_=P=>{P===u&&(u=null,i?s.tweens.add({targets:e,x:l.x,y:l.y,duration:300,ease:"Bounce.out",onComplete:()=>{s.events.emit("joystickRelease",{[n]:{isActive:!1,position:l,change:{x:0,y:0},normalized:{x:0,y:0}}})}}):s.events.emit("joystickRelease",{[n]:{isActive:!1,position:{x:e.x,y:e.y},change:{x:e.x-l.x,y:e.y-l.y},normalized:x(e.x,e.y)}}))};s.input.on("pointerdown",$),s.input.on("pointermove",g),s.input.on("pointerup",_),s.input.on("pointerupoutside",_);function A(){s.input.off("pointerdown",$),s.input.off("pointermove",g),s.input.off("pointerup",_),s.input.off("pointerupoutside",_)}return{control:(P,p)=>{let v=new Phaser.Math.Vector2,D=0;const S=new Phaser.Math.Vector2(P.x,P.y),k=new Phaser.Math.Vector2(l.x,l.y),X=(h,b)=>{if(!p.directionLock)return[h,b];if(p.directionLock===4)return Math.abs(h)>Math.abs(b)?[h,0]:[0,b];if(p.directionLock===8){const z=Math.atan2(b,h),G=Math.round(8*z/(2*Math.PI)+8)%8*Math.PI/4;return[Math.cos(G),Math.sin(G)]}return[h,b]},I=(h,b,z)=>{switch([h,b]=X(h,b),p.type){case"speed":const E=p.maxSpeed||300;P.x+=h*E*z/1e3,P.y+=b*E*z/1e3;break;case"velocity":const G=P.body;if(G){const R=p.force||1;G.setVelocity(h*R*60,b*R*60)}break;case"unit":const B=s.time.now,pt=p.repeatRate||0,fe=p.pixels||100,de=.2;if((Math.abs(h)>de||Math.abs(b)>de)&&(D===0||B-D>=pt)){const R=Math.atan2(b,h);P.x+=Math.round(Math.cos(R)*fe),P.y+=Math.round(Math.sin(R)*fe),D=B}break;case"tracked":const ue=p.multiplier||1,mt=(h-k.x)*ue,yt=(b-k.y)*ue;P.setPosition(S.x+mt,S.y+yt);break}},d=h=>{if(h[n])if(p.type==="tracked"){const b=h[n].position;I(b.x,b.y,0)}else v.set(h[n].normalized.x,h[n].normalized.y),D===0&&I(v.x,v.y,0)},m=h=>{if(h[n])if(v.reset(),D=0,p.type==="velocity"){const b=P.body;b&&b.setVelocity(0,0)}else p.type==="tracked"&&r.bounceBack&&P.setPosition(S.x,S.y)},L=(h,b)=>{p.type!=="tracked"&&(v.x!==0||v.y!==0)&&I(v.x,v.y,b)};return s.events.on("joystickActive",d),s.events.on("joystickRelease",m),s.events.on("update",L),{destroy:()=>{A(),s.events.off("joystickActive",d),s.events.off("joystickRelease",m),s.events.off("update",L)}}},destroy:A}}}function ct(o,e,t){let n=new Phaser.Geom.Point,r=Number.MAX_VALUE;for(let s=0;s<o.points.length;s++){const i=o.points[s],a=o.points[(s+1)%o.points.length],l=ft(i,a,e,t),c=Phaser.Math.Distance.Between(e,t,l.x,l.y);c<r&&(r=c,n=l)}return n}function ft(o,e,t,n){const r=e.x-o.x,s=e.y-o.y,i=((t-o.x)*r+(n-o.y)*s)/(r*r+s*s),a=Phaser.Math.Clamp(i,0,1);return new Phaser.Geom.Point(o.x+a*r,o.y+a*s)}function ce(o){let e=0,t=0;for(const n of o.points)e+=n.x,t+=n.y;return new Phaser.Geom.Point(e/o.points.length,t/o.points.length)}function dt(o){return function(e,t,n={}){const r=e.scene,i={...{targetPositionY:"center",targetPositionX:"center",targetOffset:[0,0],speed:300,easing:!0},...n};let a,l,c=0,f=0;switch(Array.isArray(t)?[a,l]=t:(a=t.x,l=t.y,c=t.width||0,f=t.height||0),a+=c/2,l+=f/2,i.targetPositionX){case"left":a+=e.width/2;break;case"right":a-=e.width/2;break}switch(i.targetPositionY){case"top":l+=e.height/2;break;case"bottom":l-=e.height/2;break}a+=i.targetOffset[0],l+=i.targetOffset[1];const u=a-e.width/2,y=l-e.height/2,x=u-e.scrollX,w=i.speed;let $=Phaser.Math.Easing.Linear;i.easing===!0?$=Phaser.Math.Easing.Cubic.InOut:typeof i.easing=="function"&&($=i.easing),r.events.emit("panToStart"),r.tweens.add({targets:e,scrollX:u,scrollY:y,duration:w,ease:$,onUpdate:()=>{const g=1-(e.scrollX-u)/x;r.events.emit("panToProgress",g)},onComplete:()=>{r.events.emit("panToComplete")}})}}function ut(o){return function(e){const{camera:t,target:n,scrollFactor:r=.25}=e;if(!n){console.warn('[P2P parallax] No valid "target" was provided.');return}let s,i;if(typeof t=="string"){if(i=n.scene,!i){console.warn(`[P2P parallax] Could not resolve scene from target for camera "${t}".`);return}s=i.cameras.getCamera(t),s||(s=i.cameras.main)}else if(t instanceof Phaser.Cameras.Scene2D.Camera)s=t,i=s.scene;else{if(i=n.scene,!i){console.warn("[P2P parallax] Could not find scene from target to use a default camera.");return}s=i.cameras.main}if(!s){console.warn("[P2P parallax] Could not resolve a valid camera.");return}if(!i){console.warn("[P2P parallax] Could not resolve a valid scene.");return}const a=i.sys;a._parallaxItems||(a._parallaxItems=[],i.events.on("update",()=>{const l=a._parallaxItems||[];for(const c of l)c.target.x=c.initX+c.camera.scrollX*c.factor,c.target.y=c.initY+c.camera.scrollY*c.factor})),a._parallaxItems.push({target:n,camera:s,factor:r,initX:n.x,initY:n.y})}}function ht(o){return{button:rt(),fillZone:at(),joystick:lt(),panTo:dt(),parallax:ut()}}class gt extends C.Plugins.BasePlugin{constructor(t){super(t);T(this,"psdData",{});T(this,"options");T(this,"load");T(this,"place");T(this,"getTexture");T(this,"use");T(this,"createCamera");this.options={},console.log("%câœ¨ PSD-to-Phaser v0.0.5 âœ¨","background: black; color: white; padding: 1px 3px; border-radius: 2px;"),this.load=Ae(this),this.place=et(this),this.getTexture=tt(this),this.use=ht(),this.createCamera=(n,r,s)=>it(this,n,r,s)}init(t={}){this.options={debug:!1,applyAlphaAll:!1,applyBlendModesAll:!1,...t},typeof this.options.debug=="boolean"&&(this.options.debug=this.options.debug?{shape:!0,label:!0,console:!0}:!1),this.options.debug&&console.log("PsdToPhaserPlugin initialized with options:",this.options)}setData(t,n){this.psdData[t]=n,this.isDebugEnabled("console")&&console.log(`Data set for key "${t}":`,n)}getData(t){return this.psdData[t]}getAllKeys(){return Object.keys(this.psdData)}isDebugEnabled(t){return typeof this.options.debug=="object"&&!!this.options.debug[t]}}return gt}));
